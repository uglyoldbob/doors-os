<!-- saved from url=(0069)http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html -->
<html>

<head>
<meta http-equiv="Content-Type"
content="text/html; charset=iso-8859-1">
<meta name="GENERATOR" content="Microsoft FrontPage Express 2.0">
<title>Programming the NEC µPD765 and Intel 82072/7 Floppy Disk Controller</title>
<!---------------------------------------------------------------------------------------->
</head>

<body bgcolor="#FFFFCC" link="#FF0000" vlink="#800080"
alink="#808000" onmove="FOd2()" onresize="FOd2()"
onscroll="FOd2()" onload="FOd1()">
<script>
<!--
var FOd3=0;
var FOd4=62;
var FOd5=470;
var FOd6=12;
var FOd7=200;
var FOd8=0;
var FOd9=0;
var FOd0,FOd10;
var FOd11,FOd12,FOd13,FOd8,FOd14;
var FOd15,FOd16,FOd17=500;
function FOd1()
{
if(FOd8==1)
return true;
if(document.all)
{
FOd11=document.all("FOd18").style;
FOd12=document.all("FOd19").style;
FOd20=FOd4+FOd3+0;
FOd21=FOd5+FOd6+FOd3;
FOd22='visible';
FOd23='hidden';
}
else
{
FOd22='show';
FOd23='hide';
FOd11=document.FOd18;
FOd12=document.FOd19;
FOd20=FOd4+FOd3+15;
FOd21=FOd5+FOd6+FOd3+15;
}
if(FOd0=="00434818")
{
if(document.all)
{
FOd12.display='none';
FOd11.display='none';
}
return true;
}
if(document.all)
{
if(document.body.clientHeight<FOd7||document.body.clientWidth<FOd7)
return true;
}
else if(document.layers)
{
if(window.innerHeight<FOd7||window.innerWidth<FOd7)
return true;
}
FOd8=1;
FOd2();
FOd11.visibility=FOd22;
if(document.layers)
FOd24();
}
function FOd24()
{
if(pageXOffset!=FOd15||pageYOffset!=FOd16)
{
FOd15=pageXOffset;
FOd16=pageYOffset;
FOd2();
if(FOd17>=500)
{
FOd17=20;
setTimeout("checkTime=500",1000);
}
}
FOd10=setTimeout("FOd24()",FOd17);
}
function FOd2()
{
if(!FOd8)
return true;
if(document.all)
{
if(document.body.scrollHeight<document.body.clientHeight
||document.body.scrollTop<((document.body.scrollHeight-document.body.clientHeight)/2))
{
FOd11.top=document.body.scrollTop+document.body.clientHeight-FOd20;
FOd12.top=document.body.scrollTop+document.body.clientHeight-FOd20;
}
else
{
FOd11.top=document.body.scrollTop+FOd3;
FOd12.top=document.body.scrollTop+FOd3;
}
FOd11.left=document.body.scrollLeft+document.body.clientWidth-FOd21;
FOd12.left=document.body.scrollLeft+document.body.clientWidth-FOd21+FOd5;
}
else if(document.layers)
{
if(window.pageYOffset<((window.outerHeight-window.innerHeight)/2))
{
FOd11.top=window.pageYOffset+window.innerHeight-FOd20;
FOd12.top=window.pageYOffset+window.innerHeight-FOd20;
}
else
{
FOd11.top=window.pageYOffset+FOd3;
FOd12.top=window.pageYOffset+FOd3;
}
FOd11.left=window.pageXOffset+window.innerWidth-FOd21;
FOd12.left=window.pageXOffset+window.innerWidth-FOd21+FOd5;
}
}
function FOd25()
{
FOd9=1;
FOd12.visibility=FOd22;
FOd11.visibility=FOd23;
clearTimeout(FOd14);
}
function FOd26()
{
FOd9=0;
FOd12.visibility=FOd23;
FOd11.visibility=FOd22;
}
//-->
</script>

<table border="0" cellpadding="0" cellspacing="0" height="62">
    
</table>

<table border="0" cellpadding="0" cellspacing="0" width="100%">
    <font face="Arial"><TBODY></font>
    <tr>
        <td><h1 align="center"><font face="Arial">Programming
        Floppy Disk Controllers </font></h1>
        <p><font face="Arial"><br>
        </font></p>
        <p align="center" title><font face="Arial">[ </font><a
        href="http://debs.future.easyspace.com/index.html"><font
        face="Arial">Home </font></a><font face="Arial">] [ </font><a
        href="http://debs.future.easyspace.com/Programming/index.html"
        title="Programming Home"><font face="Arial">Programming </font></a><font
        face="Arial">] </font></p>
        </td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<hr size="3" color="#808080">

<p><font face="Arial"><br>
<br>
<!----------------------------------------------------------------------------------------></font></p>

<table border="0" cellpadding="10" cellspacing="0" width="100%">
    <font face="Arial"><TBODY></font>
    <tr>
        <td valign="top" width="10"><font face="Arial">[ </font><a
        href="http://debs.future.easyspace.com/Index.html"><font
        face="Arial">Home </font></a><font face="Arial">] <br>
        [ </font><a
        href="http://debs.future.easyspace.com/Programming/Index.html"
        title="Programming Home"><font face="Arial">Programming </font></a><font
        face="Arial">] </font></td>
        <td><font face="Arial">The purpose of this document is to
        provide information related to programming the NEC
        µPD765 and the Intel 82072/7 Floppy Disk Controllers
        (FDCs), by use of the registers. The document is split
        into several sections: </font><p><font face="Arial"><br>
        </font></p>
        <ol>
            <li><a
                href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#Overview"><font
                face="Arial">Overview </font></a></li>
            <li><a
                href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#Configuration"><font
                face="Arial">Configuration of an FDC on a PC </font></a></li>
            <li><a
                href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#FDC Registers"><font
                face="Arial">FDC Registers </font></a></li>
            <li><a
                href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#Commands"><font
                face="Arial">Command Set </font></a></li>
        </ol>
        <p><font face="Arial"><br>
        </font></p>
        </td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<hr size="3" color="#808080">
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h2 align="center"><a name="Overview"><font face="Arial">Overview
</font></a></h2>

<p><font face="Arial">The PC usually uses the NEC µPD765 floppy
disk controller. The AT can also incorporate an Intel 82072A
controller, while the PS/2 uses an Intel 82077A. The µPD765 and
the ROM code in the controller form a microcontroller, and this
handles the majority of the work of the controller. All PC
compatibles have FDCs which are compatible with the controllers
described in this document. </font></p>

<p><font face="Arial">This document describes the registers used
to interface with the controller, and the commands which it
recognises. </font></p>

<p><font face="Arial">There are a lot of delays involved in
communicating with the controller. These delays are for a variety
of reasons, including the time needed to spin up the drive motor,
and the time taken to move the head to a new position and wait
for it to settle in place. </font></p>

<p><font face="Arial">When the drive motor is started up or the a
seek is requested, there will be a delay until the drive is ready
for the next command. An interrupt is issued by the hardware when
it is ready for the next command, and this will tell you that the
drive is ready for your command. </font></p>

<p><font face="Arial">In a single tasked environment (such as
DOS), the only option is to have your driver constantly wait for
an interrupt, and then respond to it. However, in a multi-tasked
or multi-threaded environment, it is perfectly acceptable to
write a driver which allows other tasks to be executed while
waiting for the interrupt. </font></p>

<p><font face="Arial">When performing a read or write operation,
data may be transferred a byte at a time by reading from or
writing to the appropriate port, or a sector/track at a time
through the use of DMA channel 2. Programming the DMA controller
is beyond the scope of this document, but will be described in a
future document to be added to this site. </font></p>

<p><font face="Arial">The registers, what they do and what
commands can be used are all detailed in the following sections.
If there are any errors, I will gratefully accept any feedback
you might like to send to me via </font><a
href="mailto:debs@savah.freeserve.co.uk"><font face="Arial">e-mail
</font></a><font face="Arial">. </font></p>

<hr size="3" color="#808080">

<p><font face="Arial"><br>
<br>
<!----------------------------------------------------------------------------------------></font></p>

<h2 align="center"><a name="Configuration"><font face="Arial">Configuration
of an FDC on a PC </font></a></h2>

<p><font face="Arial">The Floppy Controller on a PC uses a
standard configuration. On the XT there are 3 ports available for
control and data access registers. On the AT, there are 4, and on
the PS/2 there are 6. </font></p>

<p><font face="Arial">The base port address used for the
controller is dependant on whether the controller is configured
as the primary or secondary controller. This base address
controls the port addresses used for each of the registers on the
controller. It can additionally be noted that all floppy
controllers on a PC use DMA channel 2 for data transfer during a
read or write, and they all issue a hardware interrupt via IRQ6
to be serviced by INT 0eh by default. </font></p>

<p><font face="Arial"><br>
</font></p>

<table border="1" cellpadding="0" cellspacing="0">
    <font face="Arial"><TBODY></font>
    <tr>
        <td align="center" width="300"><font face="Arial">&nbsp; </font></td>
        <td align="center" width="75"><font face="Arial"><strong>Primary
        <br>
        Address </strong></font></td>
        <td align="center" width="75"><font face="Arial"><strong>Secondary
        <br>
        Address </strong></font></td>
        <td align="center" width="75"><font face="Arial"><strong>Write
        (W) <br>
        Read (R) </strong></font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">&nbsp; </font></td>
        <td align="center"><font face="Arial">&nbsp; </font></td>
        <td align="center"><font face="Arial">&nbsp; </font></td>
        <td align="center"><font face="Arial">&nbsp; </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">base address </font></td>
        <td align="center"><font face="Arial">3f0h </font></td>
        <td align="center"><font face="Arial">370h </font></td>
        <td align="center"><font face="Arial">&nbsp; </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">status register A
        (PS/2) </font></td>
        <td align="center"><font face="Arial">3f0h </font></td>
        <td align="center"><font face="Arial">370h </font></td>
        <td align="center"><font face="Arial">R </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">status register B
        (PS/2) </font></td>
        <td align="center"><font face="Arial">3f1h </font></td>
        <td align="center"><font face="Arial">371h </font></td>
        <td align="center"><font face="Arial">R </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">digital output
        register DOR </font></td>
        <td align="center"><font face="Arial">3f2h </font></td>
        <td align="center"><font face="Arial">372h </font></td>
        <td align="center"><font face="Arial">W </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">main status
        register </font></td>
        <td align="center"><font face="Arial">3f4h </font></td>
        <td align="center"><font face="Arial">374h </font></td>
        <td align="center"><font face="Arial">R </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">data rate select
        register (DSR)(PS/2) </font></td>
        <td align="center"><font face="Arial">3f4h </font></td>
        <td align="center"><font face="Arial">374h </font></td>
        <td align="center"><font face="Arial">W </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">data register </font></td>
        <td align="center"><font face="Arial">3f5h </font></td>
        <td align="center"><font face="Arial">375h </font></td>
        <td align="center"><font face="Arial">R/W </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">digital input
        register DIR (AT) </font></td>
        <td align="center"><font face="Arial">3f7h </font></td>
        <td align="center"><font face="Arial">377h </font></td>
        <td align="center"><font face="Arial">R </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">configuration
        control register (AT) </font></td>
        <td align="center"><font face="Arial">3f7h </font></td>
        <td align="center"><font face="Arial">377h </font></td>
        <td align="center"><font face="Arial">W </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">DMA channel </font></td>
        <td align="center"><font face="Arial">2 </font></td>
        <td align="center"><font face="Arial">2 </font></td>
        <td align="center"><font face="Arial">&nbsp; </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">IRQ </font></td>
        <td align="center"><font face="Arial">6 </font></td>
        <td align="center"><font face="Arial">6 </font></td>
        <td align="center"><font face="Arial">&nbsp; </font></td>
    </tr>
    <tr>
        <td align="center"><font face="Arial">INTR </font></td>
        <td align="center"><font face="Arial">0eh </font></td>
        <td align="center"><font face="Arial">0eh </font></td>
        <td align="center"><font face="Arial">&nbsp; </font></td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
<br>
</font></p>

<p><font face="Arial">Note that the controller can be configured
differently from the defaults for handling interrupts. </font></p>

<hr size="3" color="#808080">

<p><font face="Arial"><br>
<br>
<!----------------------------------------------------------------------------------------></font></p>

<h2 align="center"><a name="FDC Registers"><font face="Arial">FDC
Registers </font></a></h2>

<p><font face="Arial">This section gives more detailed
information on the use of the registers listed in the above
table. Additionally, the first registers to be described are
those common to each system described, and these will be followed
by descriptions of AT specific registers and PS/2 specific
registers. </font></p>

<p><font face="Arial">Common Registers: </font></p>

<ol>
    <li><a
        href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#DOR"><font
        face="Arial">Digital Output Register DOR </font></a></li>
    <li><a
        href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#MSR"><font
        face="Arial">Main Status Register </font></a></li>
    <li><a
        href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#Data"><font
        face="Arial">Data Register </font></a></li>
</ol>

<p><font face="Arial">AT Specific Registers: </font></p>

<ol>
    <li><a
        href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#DIR"><font
        face="Arial">Digital Input Register DIR </font></a></li>
    <li><a
        href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#CCR"><font
        face="Arial">Configuration Control Register </font></a></li>
</ol>

<p><font face="Arial">PS/2 Specific Registers: </font></p>

<ol>
    <li><a
        href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#Status"><font
        face="Arial">Status Register A </font></a></li>
    <li><a
        href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#Status"><font
        face="Arial">Status Register B </font></a></li>
    <li><a
        href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#DRSR"><font
        face="Arial">Data Rate Select Register </font></a></li>
</ol>

<hr>

<h3><a name="DOR"><font face="Arial">Digital Output Register DOR </font></a></h3>

<p align="center"><font face="Arial"><img
src="ProgrammingFloppyDiskController_files/DOR.gif"
alt="image of Digital Output Register" width="260" height="136"
title="Digital Output Register"> </font></p>

<table border="0" cellpadding="2" width="550">
    <font face="Arial"><TBODY></font>
    <tr>
        <td><font size="2" face="Arial"><strong>MOTD, MOTC, MOTB,
        MOTA:</strong></font><font face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Motor control for
        floppy drive D, C, B, A </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" width="100%">
            <font face="Arial"><TBODY></font>
            <tr>
                <td width="50%"><font size="2" face="Arial">1 =
                Start motor</font><font face="Arial"> </font></td>
                <td><font size="2" face="Arial">0 = Stop motor</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>DMA:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>DMA and IRQ
        channel</strong></font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" width="100%">
            <font face="Arial"><TBODY></font>
            <tr>
                <td width="50%"><font size="2" face="Arial">1 =
                Enabled</font><font face="Arial"> </font></td>
                <td><font size="2" face="Arial">0 = Disabled</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><a style="TEXT-DECORATION: overline"><font size="2"
        face="Arial"><strong>REST: </strong></font></a></td>
        <td><font size="2" face="Arial"><strong>Controller reset</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" width="100%">
            <font face="Arial"><TBODY></font>
            <tr>
                <td width="50%"><font size="2" face="Arial">1 =
                Controller enabled</font><font face="Arial"> </font></td>
                <td><font size="2" face="Arial">0 = Execute
                controller reset</font><font face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>DR1,DR0:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Drive select</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" width="100%">
            <font face="Arial"><TBODY></font>
            <tr>
                <td width="25%"><font size="2" face="Arial">00 =
                drive 0 (A)</font><font face="Arial"> </font></td>
                <td width="25%"><font size="2" face="Arial">01 =
                drive 1 (B)</font><font face="Arial"> </font></td>
                <td width="25%"><font size="2" face="Arial">10 =
                drive 2 (C)</font><font face="Arial"> </font></td>
                <td><font size="2" face="Arial">11 = drive 3 (D)</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
<br>
</font></p>

<p><font face="Arial">This register is write only, and controls
the drive motors, as well as selecting a drive and the DMA/IRQ
mode, and resetting the controller. </font></p>

<p><font face="Arial">If the REST bit is set, the controller is
enabled, in order to accept and execute commands. If it is equal
to 0, the controller ignores all commands and carries out an
internal reset of all internal registers (except the DOR). </font></p>

<p><font face="Arial">Note that a drive cannot be selected unless
its motor is on, although setting the bits at the same time is
acceptable. </font></p>

<p><font face="Arial">Note also that drives 2 and 3 (floppy
drives C and D) are not supported in all systems. </font></p>

<p><font face="Arial"><strong>Example: </strong><br>
To start the motor on drive A and select it, ready for another
operation, you would use the following: <br>
<br>
</font></p>

<dl>
    <dd><font face="Arial">MOTA = 1 (start motor for drive A) </font></dd>
    <dd><font face="Arial">DMA = 1 (assuming you want to use DMA
        and interrupts) </font></dd>
    <dd><font face="Arial">REST = 1 (Controller enabled,
        otherwise no other commands will be executed) </font></dd>
    <dd><font face="Arial">DR1,DR0 = 00 (Select drive A) </font></dd>
    <dd><font face="Arial">All other bits are set to 0 <br>
        <br>
        Thus 16 + 8 + 4 + 0 = 28, or 01Ch, is sent to port 3f2h
        (Drive A is usually on the primary controller). </font></dd>
</dl>

<p><font face="Arial">In assembly language, this would be written
as: </font></p>

<pre><font size="5" face="Arial"><strong>
    mov     al,01ch
    mov     dx,03f2h
    out     dx,al</strong></font><font face="Arial">
    </font></pre>

<p><font face="Arial"><br>
</font></p>

<p><font face="Arial"><strong>Example: </strong><br>
To reset the controller, send 0 to port 3f2h. This turns off all
motors, selects no drives (because drive A's motor is not active,
it cannot be selected), disables the DMA and IRQ line, and resets
the controller. </font></p>

<p><font face="Arial">The code for this is as follows: <br>
<br>
</font></p>

<pre><font size="5" face="Arial"><strong>
    mov     al,0
    mov     dx,03f2h
    out     dx,al</strong></font><font face="Arial">
    </font></pre>

<p><font face="Arial"><br>
</font></p>

<hr>
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h3><a name="MSR"><font face="Arial">Main Status Register </font></a></h3>

<p align="center"><font face="Arial"><img
src="ProgrammingFloppyDiskController_files/MSR.gif"
alt="image of Main Status Register" width="260" height="136"
title="Main Status Register"> </font></p>

<table border="0" cellpadding="2" width="550">
    <font face="Arial"><TBODY></font>
    <tr>
        <td><font size="2" face="Arial"><strong>MRQ:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>main request</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" width="100%">
            <font face="Arial"><TBODY></font>
            <tr>
                <td width="50%"><font size="2" face="Arial">1 =
                data register ready</font><font face="Arial"> </font></td>
                <td><font size="2" face="Arial">0 = data register
                not ready</font><font face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>DIO:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>data input/output
        </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2" width="100%">
            <font face="Arial"><TBODY></font>
            <tr>
                <td width="50%"><font size="2" face="Arial">1 =
                controller ? CPU</font><font face="Arial"> </font></td>
                <td><font size="2" face="Arial">0 = CPU ?
                controller</font><font face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>NDMA:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>non-DMA mode </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2" width="100%">
            <font face="Arial"><TBODY></font>
            <tr>
                <td width="50%"><font size="2" face="Arial">1 =
                controller not in DMA mode</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">0 = controller in
                DMA mode</font><font face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>BUSY:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>instruction
        (device busy) </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2" width="100%">
            <font face="Arial"><TBODY></font>
            <tr>
                <td width="50%"><font size="2" face="Arial">1 =
                active</font><font face="Arial"> </font></td>
                <td><font size="2" face="Arial">0 = not active</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>ACTD, ACTC, ACTB,
        ACTA:</strong></font><font face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>drive D, C, B, A
        in positioning mode </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2" width="100%">
            <font face="Arial"><TBODY></font>
            <tr>
                <td width="50%"><font size="2" face="Arial">1 =
                active</font><font face="Arial"> </font></td>
                <td><font size="2" face="Arial">0 = not active</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
<br>
</font></p>

<p><font face="Arial">The MSR is read-only, and contains the
controller's status information. This register can be read
whatever else the controller is doing. </font></p>

<p><font face="Arial">It should be noted that this register is
different from status registers ST0-ST3, which contain data
concerning the last command executed. These registers are
accessed via the data registers. </font></p>

<p><font face="Arial">Bit 7 (MRQ) indicates whether the
controller is ready to receive or send data or commands via the
data register. </font></p>

<p><font face="Arial">DIO is used to provide an indication of
whether the controller is expecting to receive data from the CPU,
or if it wants to output data to the CPU. </font></p>

<p><font face="Arial">If the controller is set up to use DMA
channel 2 to transfer data to or from main memory, the NDMA bit
is not set. If this bit is set, data transfer is carried out
exclusively by means of read or write commands to the data
register. In this case, the controller issues a hardware
interrupt every time that it either expects to receive or wants
to supply a data byte. </font></p>

<p><font face="Arial">Bit 4 indicates whether the controller is
busy or not. If the bit is set, the controller is currently
executing a command. </font></p>

<p><font face="Arial">Bits 0-3 indicate which (if any) drive is
currently in the process of positioning it's read/write heads, or
being recalibrated. </font></p>

<p><font face="Arial">Note that the delay waiting for the
controller to be ready for a read or write can be as much as
175µs on an Intel controller, and longer on older controllers. </font></p>

<p><font face="Arial"><strong>Example: </strong><br>
To test whether the controller is ready to receive commands and
data, it is necessary to test MRQ and DIO. This involves reading
the port, masking the bits, and doing a comparison on the result
(to test the values of the bits). </font></p>

<p><font face="Arial">In assembly language, this is can be
written as: <br>
<br>
</font></p>

<pre><font size="5" face="Arial"><strong>
mrqloop:
    mov dx,03f4h
    in  al,dx
    and al,0c0h
    cmp al,080h
    jne mrqloop</strong></font><font face="Arial">
    </font></pre>

<p><font face="Arial"><br>
</font></p>

<p><font face="Arial">This code will keep looping until the
controller says that it is ready to receive data. Note that if
the controller is expecting to output data to the CPU, this code
will not spot that. You would need to add another couple of lines
of code if you need to check for both possibilities (In general,
you would know from previous commands whether the controller
should be expecting or offering data, and so only need to check
for one condition). </font></p>

<hr>
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h3><a name="Data"><font face="Arial">Data Register </font></a></h3>

<p><font face="Arial">The data register is an 8 bit register,
like each of the other registers, which provides indirect access
to a stack of registers. A command can be one to nine bytes in
length, and the first byte tells the controller how many more
bytes to expect. The controller sends the command bytes to the
correct registers in it's stack, saving the programmer from the
need to use a separate index register, as is the case in some
other devices (e.g. some VGA registers). </font></p>

<p><font face="Arial">Some controllers, such as the i82077A, have
a buffer, with a programmable threshold, allowing the data to be
transferred several bytes at a time. This helps to speed up the
transfer of data and commands, as well as reducing the response
time seen on the µPD765. </font></p>

<p><font face="Arial">Following some of the commands, the values
in the status registers are returned. The layout of the status
registers follows, with the </font><a
href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#Commands"><font
face="Arial">commands </font></a><font face="Arial">being listed
at the end of this document. </font></p>

<hr size="1">
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h4><a name="Status0"><font face="Arial">Status Register </font></a><font
face="Arial">ST0 </font></h4>

<p align="center"><font face="Arial"><img
src="ProgrammingFloppyDiskController_files/ST0.gif"
alt="image of Status Register 0" width="260" height="136"
title="Status Register 0"> </font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td><font size="2" face="Arial"><strong>IC </strong><sub><strong>1
        </strong></sub><strong>,IC </strong><sub><strong>0 </strong></sub><strong>:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>interrupt code</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2" width="100%">
            <font face="Arial"><TBODY></font>
            <tr>
                <td valign="top"><font size="2" face="Arial">00&nbsp;=&nbsp;</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">normal
                termination; <br>
                command terminated without any errors</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td valign="top"><font size="2" face="Arial">01&nbsp;=&nbsp;</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">abnormal
                termination; <br>
                the controller started execution of the command,
                but couldn't terminate it correctly</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td valign="top"><font size="2" face="Arial">10&nbsp;=&nbsp;</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">invalid command; <br>
                the controller could not start command execution</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td valign="top"><font size="2" face="Arial">11&nbsp;=&nbsp;</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">abnormal
                termination by polling; <br>
                drive became not ready</font><font face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>SE:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>seek end </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">The controller has
        completed a seek or a calibration command, <br>
        or has correctly executed a read or write command which
        has an implicit seek</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>UC:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>unit check </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">Set if the drive faults
        or if a recalibrate cannot find track 0 after 79 pulses.</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>NR:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>drive not ready </strong></font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>HD:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>head currently
        active </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td><font size="2" face="Arial">1&nbsp;=&nbsp;</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">head 1</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial">0&nbsp;=&nbsp;</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">head 0</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>US </strong><sub><strong>1
        </strong></sub><strong>, US </strong><sub><strong>0 </strong></sub></font><font
        face="Arial"><strong>: </strong></font></td>
        <td><font size="2" face="Arial"><strong>currently
        selected drive (unit select) </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td><font size="2" face="Arial">00&nbsp;=&nbsp;</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">drive 0 (A:)</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial">01&nbsp;=&nbsp;</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">drive 1 (B:)</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial">10&nbsp;=&nbsp;</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">drive 2 (C:)</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial">11&nbsp;=&nbsp;</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">drive 3 (D:)</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
</font></p>

<hr size="1">
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h4><font face="Arial">Status Register ST1 </font></h4>

<p align="center"><font face="Arial"><img
src="ProgrammingFloppyDiskController_files/ST1.gif"
alt="image of Status Register 1" width="260" height="136"
title="Status Register 1"> </font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td><font size="2" face="Arial"><strong>EN:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>End of Cylinder </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">Set when the sector count
        exceeds the number of sectors on a track. <br>
        i.e. the controller attempts to access a sector after the
        last sector of a cylinder.</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>xx:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>bit unused </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">value always equal to 0</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>DE:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>data error </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">Set if the controller
        detected an error in the ID address field or the data
        field of a sector</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>TO:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>time-out </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">Set for a data overrun; <br>
        No signal received from the DMA controller or CPU within
        the required time period.</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>NDAT:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>no data </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>Set&nbsp;if:&nbsp;</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">The addressed
                sector in a <i>read sector </i>or <i>read deleted
                sector </i>cannot be found <br>
                by the controller.</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>OR: </strong>&nbsp;</font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">The controller
                cannot read the ID address mark in response to a <i>read
                ID </i>command <br>
                without error.</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>OR:&nbsp;</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">The controller
                cannot correctly determine the sequence of
                sectors in a <i>read track </i><br>
                command</font><font face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>NW:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>not writable </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">Set if the disk in the
        selected drive is write protected while the controller
        attempts to <br>
        execute a write command.</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>NID:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>no address mark </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>Set&nbsp;if:&nbsp;</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">The ID address
                mark was not found after one complete disk
                revolution</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>OR:&nbsp;</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">The controller
                could not find: <br>
                </font><dl>
                    <dd><font size="2" face="Arial">a data
                        address mark DAM</font><font face="Arial">
                        </font></dd>
                    <dd><font size="2" face="Arial">a deleted
                        data address mark DAM <br>
                        on the specified track.</font><font
                        face="Arial"> </font></dd>
                </dl>
                </td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
</font></p>

<hr size="1">
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h4><font face="Arial">Status Register ST2 </font></h4>

<p align="center"><font face="Arial"><img
src="ProgrammingFloppyDiskController_files/ST2.gif"
alt="image of Status Register 2" width="260" height="136"
title="Status Register 2"> </font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td><font size="2" face="Arial"><strong>xx:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>bit unused </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">value always equal to 0</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>DADM:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>deleted address
        mark </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>Set if:&nbsp;</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">A deleted data
                address mark DAM is detected when a <i>read
                sector </i>command is <br>
                being executed.</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>OR:&nbsp;</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">A valid data
                address mark DAM is detected when a <i>read
                deleted sector </i>command <br>
                is being executed.</font><font face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>CRCE:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>CRC error in data
        field </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">Set if a CRC error was
        detected in the data field of the sector.</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>WCYL:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>wrong cylinder </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">Set if the track address
        in the controller and the track address in the ID address
        mark are <br>
        different.</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>SEQ:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>seek equal </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>Set&nbsp;if:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">controller is a
                µPD765 and the condition <i>seek equal </i>is
                fulfilled</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>else:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">SGL is not used,
                this field is always equal to 0</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>SERR:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>seek error </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>Set&nbsp;if:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">controller is a
                µPD765 and the controller did not find the
                corresponding sector when <br>
                seeking on the cylinder.</font><font face="Arial">
                </font></td>
            </tr>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>else:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">SERR is not used,
                this field is always equal to 0</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>BCYL:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>bad cylinder </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">This field indicates that
        the track address in the ID address mark differs from the
        track <br>
        address in the controller. <br>
        The value equals <strong>ffh </strong>, indicating a bad
        track with a physical error, according to the IBM soft <br>
        sector format.</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>NDAM:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>not data address
        mark DAM </strong></font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">Set if the controller
        cannot find a valid or deleted data address mark DAM.</font><font
        face="Arial"> </font></td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
</font></p>

<hr size="1">
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h4><font face="Arial">Status Register ST3 </font></h4>

<p align="center"><font face="Arial"><img
src="ProgrammingFloppyDiskController_files/ST3.gif"
alt="image of Status Register 3" width="260" height="136"
title="Status Register 3"> </font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td><font size="2" face="Arial"><strong>ESIG:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>error</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>Set&nbsp;if:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">controller is a
                µPD765 and the drives error signal is active <br>
                i.e. an error has occurred</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>else:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">ESIG is not used
                and is always equal to 0</font><font face="Arial">
                </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>WPDR:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>write protection</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">Set if the disk is write
        protected (indicates the write-protection line is
        active).</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>RDY:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>ready</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>Set&nbsp;if:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">controller is a
                µPD765 and the drive is ready (indicates the
                ready signal of the <br>
                drive is active).</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td align="right" valign="top"><font size="2"
                face="Arial"><strong>else:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">RDY is not used
                and this field is always set</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>TRK0:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>track 0</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">The head is above track 0
        (the TRK0 signal of the drive is active).</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>DSDR:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>double sided
        drive</strong></font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">The drive is double sided
        (indicates the DSDR signal is active).</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>HDDR:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>head</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">This bit indicates the
        status of the HDSEL signal of the drive: <br>
        1 = head 1 active, <br>
        0 = head 0 active</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>DS1,&nbsp;DS0:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>drive select</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">Both bits indicate the
        select signals DS1 and DS0 of the drive: <br>
        00 = drive 0 (A:) <br>
        01 = drive 1 (B:) <br>
        10 = drive 2 (C:) <br>
        11 = drive 3 (D:) <br>
        </font></td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
</font></p>

<hr>
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h3><a name="DIR"><font face="Arial">Digital Input Register </font></a></h3>

<p align="center"><font face="Arial">DIR (AT) <br>
<img src="ProgrammingFloppyDiskController_files/DIR_(AT).gif"
alt="image of Digital Input Register (AT)" width="260"
height="136" title="Digital Input Register (AT)"> <br>
</font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td align="middle"><font face="Arial">DIR (PS/2 except
        Model 30) <br>
        <img
        src="ProgrammingFloppyDiskController_files/DIR_(PS2_except_model_30).gif"
        alt="image of Digital Input Register (PS/2 except Model 30)"
        width="260" height="136"
        title="Digital Input Register (PS/2 except Model 30)"> </font></td>
        <td align="middle"><font face="Arial">DIR (PS/2 Model 30)
        <br>
        <img
        src="ProgrammingFloppyDiskController_files/DIR_(PS2_model_30).gif"
        alt="image of Digital Input Register (PS/2 Model 30)"
        width="260" height="136"
        title="Digital Input Register (PS/2 Model 30)"> </font></td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
</font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td><font size="2" face="Arial"><strong>CHAN:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Disk Change</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><table border="0" cellpadding="2" width="100%">
            <font face="Arial"><TBODY></font>
            <tr>
                <td><font size="2" face="Arial">1 = disk changed
                since last command</font><font face="Arial"> </font></td>
                <td><font size="2" face="Arial">0 = disk not
                changed</font><font face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>RAT1,&nbsp;RAT2:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Data Rate</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">00 = 500 kbits/s <br>
        01 = 300 kbits/s <br>
        10 = 250 kbits/s <br>
        11 = 1Mbits/s</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><a style="TEXT-DECORATION: overline"><font size="2"
        face="Arial"><strong>HiDe </strong></font></a></td>
        <td><font size="2" face="Arial"><strong>High-density Rate</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">1 = data rate 250kbits/s
        or 300 kbits/s <br>
        0 = data rate 1Mbits/s or 500 kbits/s</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>DMA:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Value of DMA bit
        in DOR</strong></font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>NOPR:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Value of NOPR bit
        in Control Configuration Register</strong></font><font
        face="Arial"> </font></td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
</font></p>

<p><font face="Arial">This register is available only in the AT
and the PS/2, and is read only. The above diagrams show that
there are 3 different configurations for this register, differing
in the AT, PS/2 and PS/2 Model 30. These registers all allow you
to detect a disk change by reading bit 7, with additional
information available for the PS/2 and Model 30 variants. </font></p>

<p><font face="Arial">For each of the registers, when bit 7 is
set, it indicates that the disk has been changed since the last
command was executed. This can be used by a driver to speed up
access to data, by buffering of data. When buffering data, if the
disk has not been changed, required sectors can already be in
memory when requested (for example, a whole track can be read at
a time and stored in a buffer, including the possibility of
storing multiple tracks when sectors are read from different
cylinders). If this happens, the data only needs reading from
disk when a new cylinder is being read from, or when the disk has
been changed. </font></p>

<p><font face="Arial">In the PS/2 and Model 30, the registers
also contain information about the current data transfer rate.
For Model 30, this information is read from bits 1 and 0, while
in the other PS/2 models, the data is read from bits 2 and 1.
This data can be used when the rate is set through the Control
Configuration Register to check that the rate has been correctly
set, or to check what rate the controller is set to at any time. </font></p>

<p><font face="Arial">In PS/2 models other than Model 30, bit 1
can be read to help determine whether the controller is set to a
high or low data transfer rate for a high density disk. </font></p>

<p><font face="Arial">In Model 30, bit 3 corresponds to bit 3 of
the DOR. bit 2 corresponds to bit 2 of the CCR (only used in this
model). In both these cases, the value is read-only in the DIR,
and can be written to in the corresponding register. </font></p>

<hr>
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h3><a name="CCR"><font face="Arial">Control Configuration
Register </font></a></h3>

<p><font face="Arial"><br align="center">
</font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td align="middle"><font face="Arial">CCR (AT and PS/2) <br>
        <img
        src="ProgrammingFloppyDiskController_files/CCR_(AT_PS2).gif"
        alt="image of Control Configuration Register (AT and PS/2)"
        width="260" height="136"
        title="Control Configuration Register (AT and PS/2)"> </font></td>
        <td align="middle"><font face="Arial">CCR (PS/2 Model 30)
        <br>
        <img
        src="ProgrammingFloppyDiskController_files/CCR_(PS2_Model_30).gif"
        alt="image of Control Configuration Register (PS/2 Model 30)"
        width="260" height="136"
        title="Control Configuration Register (PS/2 Model 30)"> </font></td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
</font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td><font size="2" face="Arial"><strong>RAT1,&nbsp;RAT0:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Data Transfer
        Rate</strong></font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">00 = 500kbits/s <br>
        01 = 300kbits/s <br>
        10 = 250kbits/s <br>
        11 - 1Mbits/s</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>NOPR:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>(No)
        Precompensate</strong></font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">0 = Precompensation
        Enabled (standard) <br>
        1 = No Precompensation</font><font face="Arial"> </font></td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
</font></p>

<p align="center"><font face="Arial"><strong>Data Transfer Rates </strong><br>
<br>
</font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td><font size="2" face="Arial"><strong>Rate</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Disk <br>
        Capacity</strong></font><font face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Size</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Drive <br>
        Capacity</strong></font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial">250 kbits/s</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">360&nbsp;kbyte</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">5¼&quot;</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">360&nbsp;kbyte</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">720&nbsp;kbyte</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">3½&quot;</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">1.44&nbsp;Mbytes</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">720&nbsp;kbyte</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">3½&quot;</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">720&nbsp;kbyte</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial">300 kbits/s</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">720&nbsp;kbyte</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">3½&quot;</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">720&nbsp;kbyte</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">360&nbsp;kbyte</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">5¼&quot;</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">1.2&nbsp;&nbsp;Mbyte</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial">500 kbits/s</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">1.2&nbsp;&nbsp;Mbyte</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">5¼&quot;</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">1.2&nbsp;&nbsp;Mbyte</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><font size="2" face="Arial">1.44&nbsp;Mbytes</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">3½&quot;</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">1.44&nbsp;Mbytes</font><font
        face="Arial"> </font></td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
</font></p>

<p><font face="Arial">In the AT and all PS/2 models, the data
transfer rate can be set through bits 1 and 0 of the CCR. Valid
transfer rates are shown in the table immediately above, and the
table below the diagram shows what values need to be sent to
these two fields to set the appropriate rate. </font></p>

<p><font face="Arial">In the Model 30 it is also possible to
program the precompensation through bit 2 of this register. The
default is for precompensate to be enabled, with this field set
to 0. Setting the field to 1 turns precompensation off. </font></p>

<hr>
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h3><a name="Status"><font face="Arial">Status Registers A and B </font></a></h3>

<p><font face="Arial"><br align="center">
</font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td align="middle"><font face="Arial">Status Register A
        (PS/2) <br>
        <img
        src="ProgrammingFloppyDiskController_files/StatusA1.gif"
        alt="image of Status Register A (PS/2)" width="260"
        height="136" title="Status Register A (PS/2)"> </font></td>
        <td align="middle"><font face="Arial">Status Register A
        (Model 30) <br>
        <img
        src="ProgrammingFloppyDiskController_files/StatusA2.gif"
        alt="image of Status Register A (Model 30)" width="260"
        height="136" title="Status Register A (Model 30)"> </font></td>
    </tr>
    <tr>
        <td align="middle" valign="top"><table border="0"
        cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td><font size="2" face="Arial"><strong>INTP:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Interrupt
                Pending</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = interrupt
                signal inactive <br>
                1 = active</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td valign="top"><a
                style="TEXT-DECORATION: overline"><font size="2"
                face="Arial"><strong>DRV2 </strong></font></a><font
                size="2" face="Arial"><strong>:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">0 = 2 drives
                connected <br>
                1 = one drive only</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>STEP:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Stepper
                Pulse</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = no pulse <br>
                1 = pulse is submitted</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><a style="TEXT-DECORATION: overline"><font
                size="2" face="Arial"><strong>TRK0 </strong></font></a><font
                size="2" face="Arial"><strong>:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Track 0</strong></font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = head not
                above track 0 <br>
                1 = head above track 0</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>HDSL:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Head
                Select</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = head 0 <br>
                1 = head 1</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><a style="TEXT-DECORATION: overline"><font
                size="2" face="Arial"><strong>INDX </strong></font></a><font
                size="2" face="Arial"><strong>:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Index
                Mark</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = detected <br>
                1 = not detected</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><a style="TEXT-DECORATION: overline"><font
                size="2" face="Arial"><strong>WP </strong></font></a><font
                size="2" face="Arial"><strong>:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Write
                Protection</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = disk write
                protected <br>
                1 = not write protected</font><font face="Arial">
                </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>DIR:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Direction
                of Head</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = outwards (to
                smaller cylinder numbers) <br>
                1 = inwards (to higher cylinder numbers)</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
        <td align="middle" valign="top"><table border="0"
        cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td><font size="2" face="Arial"><strong>INTP:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Interrupt
                Pending</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = interrupt
                signal inactive <br>
                1 = active</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>DRQ:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>DMA
                Request</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = not active <br>
                1 = active</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>STEP:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Step
                Pulse</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = pulse is
                submitted <br>
                1 = no pulse</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>TRK0:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Track 0</strong></font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = head above
                track 0 <br>
                1 = head not above track 0</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><a style="TEXT-DECORATION: overline"><font
                size="2" face="Arial"><strong>HDSL </strong></font></a><font
                size="2" face="Arial"><strong>:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Head
                Select</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = head 1 <br>
                1 = head 0</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>INDX:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Index
                Mark</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = not detected <br>
                1 = detected</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>WP:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Write
                Protection</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = disk not
                write protected <br>
                1 = disk write protected</font><font face="Arial">
                </font></td>
            </tr>
            <tr>
                <td><a style="TEXT-DECORATION: overline"><font
                size="2" face="Arial"><strong>DIR </strong></font></a><font
                size="2" face="Arial"><strong>:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Head
                Direction</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = inwards (to
                higher cylinder numbers) <br>
                1 = outwards (to lower cylinder numbers)</font><font
                face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
<br>
<br title align="center">
</font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td align="middle"><font face="Arial">Status Register B
        (PS/2) <br>
        <img
        src="ProgrammingFloppyDiskController_files/StatusB1.gif"
        alt="image of Status Register B (PS/2)" width="260"
        height="136" title="Status Register B (PS/2)"> </font></td>
        <td align="middle"><font face="Arial">Status Register B
        (Model 30) <br>
        <img
        src="ProgrammingFloppyDiskController_files/StatusB2.gif"
        alt="image of Status Register B (Model 30)" width="260"
        height="136" title="Status Register B (Model 30)"> </font></td>
    </tr>
    <tr>
        <td align="middle" valign="top"><table border="0"
        cellpadding="2">
            <font face="Arial"><TBODY></font>
            <tr>
                <td><font size="2" face="Arial"><strong>DS0:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Drive
                Select</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = drive other
                than 0 <br>
                1 = drive 0</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>WDAT:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Write
                Data</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = no data can
                be written to drive <br>
                1 = data can be transferred to drive</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>RDAT:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Read Data</strong></font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = no data can
                be read from drive <br>
                1 = data can be transferred from drive</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>WE:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Write
                Enabled</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = head is set
                to read data <br>
                1 = head is activated for data writes</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>MOT1,&nbsp;MOT0:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Motor of
                drive 1, 0</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = motor is
                switched off <br>
                1 = motor is switched on</font><font face="Arial">
                </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
        <td align="middle" valign="top"><table border="0">
            <font face="Arial"><TBODY></font>
            <tr>
                <td><a style="TEXT-DECORATION: overline"><font
                size="2" face="Arial"><strong>DRV2 </strong></font></a><font
                size="2" face="Arial"><strong>:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial">0 = two drives
                connected <br>
                1 = only one drive connected</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><a style="TEXT-DECORATION: overline"><font
                size="2" face="Arial"><strong>DS1 </strong></font></a><font
                size="2" face="Arial"><strong>:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Drive
                Select 1</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = drive 1
                selected <br>
                1 = drive not selected</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><a style="TEXT-DECORATION: overline"><font
                size="2" face="Arial"><strong>DS0 </strong></font></a><font
                size="2" face="Arial"><strong>:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Drive
                Select 0</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = drive 0
                selected <br>
                1 = drive not selected</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>WDAT:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Write
                Data</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = no data can
                be written <br>
                1 = data can be transferred to the drive</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>RDAT:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Read Data</strong></font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0&nbsp;= data
                cannot be read from drive <br>
                1 = data can be read from drive</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><font size="2" face="Arial"><strong>WE:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Write
                Enabled</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = head enabled
                to read data <br>
                1 = head enabled to write data</font><font
                face="Arial"> </font></td>
            </tr>
            <tr>
                <td><a style="TEXT-DECORATION: overline"><font
                size="2" face="Arial"><strong>DS3 </strong></font></a><font
                size="2" face="Arial"><strong>:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Drive
                Select 3</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = drive 3
                selected <br>
                1 = drive not selected</font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td><a style="TEXT-DECORATION: overline"><font
                size="2" face="Arial"><strong>DS2 </strong></font></a><font
                size="2" face="Arial"><strong>:</strong></font><font
                face="Arial"> </font></td>
                <td><font size="2" face="Arial"><strong>Drive
                Select 2</strong></font><font face="Arial"> </font></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td><font size="2" face="Arial">0 = drive 2
                selected <br>
                1 = drive not selected</font><font face="Arial"> </font></td>
            </tr>
            <font face="Arial"></TBODY></font>
        </table>
        </td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<br>
</font></p>

<p><font face="Arial">These registers are read only, and only
available on the PS/2. </font></p>

<p><font face="Arial">By the use of the two status registers A
and B on a PS/2, it is possible to read the status of the control
lines between the floppy controller and drive. Register bits </font><a
style="TEXT-DECORATION: overline"><font face="Arial">DRV2 </font></a><font
face="Arial">, </font><a style="TEXT-DECORATION: overline"><font
face="Arial">TRK0 </font></a><font face="Arial">, </font><a
style="TEXT-DECORATION: overline"><font face="Arial">INDX </font></a><font
face="Arial">, </font><a style="TEXT-DECORATION: overline"><font
face="Arial">WP </font></a><font face="Arial">and RDAT indicate
the status of the corresponding data lines. Note that the bit
values vary between Status Registers A and B on Model 30 and
other PS/2 models. Some of the values are also detectable through
other registers and the Status Registers readable through the
data register on the AT. </font></p>

<hr>
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h3><a name="DRSR"><font face="Arial">Data Rate Select Register </font></a></h3>

<p><font face="Arial"><br>
</font></p>

<p><font face="Arial">If you know of any source of information on
this register (available only on the PS/2), please </font><a
href="mailto:debs@savah.freeserve.co.uk"><font face="Arial">e-mail
</font></a><font face="Arial">me with details. As soon as I am
able to find the information, it will be added to this page. </font></p>

<hr size="3" color="#808080">
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h2 align="center"><a name="Commands"><font face="Arial">Command
Set </font></a></h2>

<p><font face="Arial">There are a total of 13 commands available
on the µPD765 and compatible FDCs. A further 4 commands are
available on the 8207x controllers. </font></p>

<p><font face="Arial">The <i>sector identification </i>consists
of the cylinder, head, sector number and sector size. This tells
the controller the position and number of sectors to perform this
command on. </font></p>

<p><font face="Arial">All commands and status bytes are
transferred via the data register, at port 37fh or 377h. Before
the command can be written or the status byte read, it is
necessary to read the MRQ bit in the main status register. This
determines whether the data register is ready to supply or
receive a byte. It is also necessary to fix the drive format
prior to any read, write or format operation. </font></p>

<p><font face="Arial">For most data transfers, DMA is used.
Although the programming of the DMA is beyond the scope of this
document, I have provided some </font><a
href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#DMA_Prog"><font
face="Arial">example code </font></a><font face="Arial">showing
how to set up the DMA for writing a single sector from a floppy
disk drive to main memory. All data transfers concern all sectors
from the start sector to the end of the track. The operation can
be stopped earlier by either setting the command byte <i>track
length/max. sector number </i>to a value which indicates the last
sector to be operated on, or setting the count value of the DMA
controller so that it issues a TC (Terminal Count) signal after
the required number of sectors are transfered (the latter method
is demonstrated in the </font><a
href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#DMA_Prog"><font
face="Arial">example DMA code </font></a><font face="Arial">below).
</font></p>

<p><font face="Arial">If you want a command to be executed on
both heads, you need to set the Multiple Track Bit. This tells
the controller to operate on the programmed head first, then to
carry out the same command from the start of the other head. </font></p>

<p><font face="Arial">Once the command has been completed, the
status registers ST0-3 return information which can help you
either confirm correct execution of the command, or determine the
cause of an error. </font></p>

<p><font face="Arial">The commands fall into 3 categories. Data
transfer commands and control commands are available on all
controllers. The extended commands are only available on the AT
or PS/2. </font></p>

<hr>
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h3><font face="Arial">List of Valid Commands </font></h3>
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h4><a
href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#datacom"><font
face="Arial">Data Transfer Commands </font></a></h4>

<pre><font face="Arial">Command Name            | Function
        -----------------------------------------
        read complete track     | x2h
        write sector            | x5h
        read sector             | x6h
        write deleted sector    | x9h
        read deleted sector     | xch
        format track            | xdh
    </font></pre>
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h4><a
href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#ctrlcom"><font
face="Arial">Control Commands </font></a></h4>

<pre><font face="Arial">Command Name            | Function
        -----------------------------------------
        fix drive data          | x3h
        check drive status      | x4h
        calibrate drive         | x7h
        check interrupt status  | x8h
        read sector ID          | xah
        seek/park head          | xfh
        invalid command         | all invalid opcodes
    </font></pre>
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h4><a
href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#extcom"><font
face="Arial">Extended Commands </font></a></h4>

<pre><font face="Arial">Command Name                  | Function
        -----------------------------------------------
        register summary              | 0fh
        determine controller version  | x10h
        verify                        | x16h
        seek relative                 | 1xfh
    </font></pre>

<p><font face="Arial">In each of the above, 'x' refers to bits
7-5 of byte 0 of the command. Note that in the <i>seek relative </i>command,
x refers to just bits 6 and 5, as bit 7 is always set to 1. The
remainder of the function number refers to bits 4-0. Bit 4 is
only used on the AT and PS/2, in 2 of the extended commands. </font></p>

<p><font face="Arial">The function number given is the first byte
of the command it applies to. The commands vary in size from 1 to
9 bytes, and the controller knows from the function number how
many more bytes to expect. For example, if the first byte
received by the data register is <b>66h </b>, in which the upper
5 bits are 06h, the controller knows that you are sending a <i>read
sector </i>command, and it expects 8 more bytes from the CPU.
Additionally, you do nto need to worry about which of the
internal registers each byte of any command has to be directed
to, as the controller does that for you. </font></p>

<p><font face="Arial">Fields common to many of the commands
include the following: </font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td valign="top"><font size="2" face="Arial"><strong>M:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Multi-track
        operation </strong><br>
        1 = carry out operation on both tracks of programmed
        cylinder. <br>
        0 = carry out operation on single track.</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td valign="top"><font size="2" face="Arial"><strong>F:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>FM/MFM mode </strong><br>
        1 = operate in MFM (double density) mode (default) <br>
        0 = operate in FM (single density) mode</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td valign="top"><font size="2" face="Arial"><strong>S:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Skip mode </strong><br>
        1 = skip deleted data address marks, 0 = do not skip</font><font
        face="Arial"> </font></td>
    </tr>
    <tr>
        <td valign="top"><font size="2" face="Arial"><strong>HD:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>head number </strong><br>
        (always equal to head address in byte 3 of all commands
        using a sector ID)</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td valign="top"><font size="2" face="Arial"><strong>DR1,DR0:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Drive: </strong><br>
        00 = drive 0 (A); 01 = drive 1 (B); 10 = drive 2 (C); 11
        = drive 3 (D)</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>Cylinder, Head,
        Sector Number:</strong></font><font face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Address of first
        sector to read.</strong></font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td valign="top"><font size="2" face="Arial"><strong>Sector
        size code:</strong></font><font face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Sector size </strong>=
        128 * 2^x where x is the value in this field. <br>
        eg If this field is 2 (the default), sector size = 128 *
        2^2 = 512 bytes</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td valign="top"><font size="2" face="Arial"><strong>Track
        length/Max sector number:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>Number of sectors
        per track or max. sector number </strong>to operate
        command on.</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td valign="top"><font size="2" face="Arial"><strong>Length
        of GAP 3:</strong></font><font face="Arial"> </font></td>
        <td><font size="2" face="Arial">Standard value = 42,
        minimal value = 32 (5¼&quot;) <br>
        standard value = 27 (3½&quot;)</font><font face="Arial">
        </font></td>
    </tr>
    <tr>
        <td valign="top"><font size="2" face="Arial"><strong>Data
        length:</strong></font><font face="Arial"> </font></td>
        <td><font size="2" face="Arial"><strong>length of data to
        read </strong><br>
        in bytes (only valid if sector size = 0, else equal 0ffh)</font><font
        face="Arial"> </font></td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<hr>
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h3><a name="datacom"><font face="Arial">Data Transfer Commands </font></a></h3>

<p><font face="Arial">These are the commands used to transfer
data between a disk and main memory, or to format a track. </font></p>

<p><font face="Arial">Each of these commands returns its' </font><a
href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#Results1"><font
face="Arial">results </font></a><font face="Arial">in the same
format, which is only described for the <i>read track </i>command.
</font></p>

<hr size="1">
<font face="Arial"><!----------------------------------------------------------------------------------------></font>

<h4><font face="Arial">Read Track (x2h) </font></h4>

<p align="center"><font face="Arial"><img
src="ProgrammingFloppyDiskController_files/rdtrk.gif"
alt="Image of Read Track Command" width="300" height="240"
title="Read Track Command"> </font></p>

<p><font face="Arial">When a <i>read track </i>command is issued,
the data of a single complete track is read. The sector
specification in the command phase is ignored for this command,
and the reading starts with the first sector after the index
address mark <strong>IDAM </strong>, reading sector by sector
(paying no attention to the logical sector number given in the ID
address mark), until the end of the track is reached. </font></p>

<p><font face="Arial">The track is treated as a contigusous data
block, and the read buffer in main memory should be large enough
to store this amount of data. Also, multi-track operations are
not allowed with this command. If you want to read the same track
on both heads, you have to send the command twice, unlike other
read commands which allow for multi-track operations with a
single command. </font></p>

<h4><a name="Results1"><font face="Arial">Results Phase </font></a></h4>

<p align="center"><font face="Arial"><img
src="ProgrammingFloppyDiskController_files/Result1.gif"
alt="image of Data Transfer Command Results Phase" width="290"
height="175" title="Data Transfer Command Results Phase"> </font></p>

<table border="0">
    <font face="Arial"><TBODY></font>
    <tr>
        <td><font size="2" face="Arial"><strong>ST0,&nbsp;ST1,&nbsp;ST2:</strong></font><font
        face="Arial"> </font></td>
        <td><a
        href="http://debs.future.easyspace.com/Programming/Hardware/FDC/floppy.html#Status0"><font
        size="2" face="Arial">Status Registers </font></a><font
        size="2" face="Arial">0 to 2</font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial"><strong>Cylinder,&nbsp;head,
        sector number,&nbsp;sector size:</strong></font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">Sector ID. (see table
        below)</font><font face="Arial"> </font></td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>

<p><font face="Arial"><br>
<strong>Sector ID in the Result Phase </strong><br>
</font></p>

<table border="0" cellpadding="2">
    <font face="Arial"><TBODY></font>
    <tr>
        <td valign="top"><font size="2" face="Arial"><strong>M&nbsp;&nbsp;</strong></font><font
        face="Arial"> </font></td>
        <td valign="top"><font size="2" face="Arial"><strong>HD </strong><sub><strong>prog
        </strong></sub><strong>&nbsp;&nbsp;</strong></font><font
        face="Arial"> </font></td>
        <td valign="top"><font size="2" face="Arial"><strong>Last
        sector affected&nbsp;&nbsp; <br>
        by command</strong></font><font face="Arial"> </font></td>
        <td valign="top"><font size="2" face="Arial"><strong>Cylinder&nbsp;&nbsp;</strong></font><font
        face="Arial"> </font></td>
        <td valign="top"><font size="2" face="Arial"><strong>Head&nbsp;&nbsp;</strong></font><font
        face="Arial"> </font></td>
        <td valign="top"><font size="2" face="Arial"><strong>Sector&nbsp;&nbsp;</strong></font><font
        face="Arial"> </font></td>
        <td valign="top"><font size="2" face="Arial"><strong>Sector
        Size</strong></font><font face="Arial"> </font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial">0</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">0</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">before end of track</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">cyl <sub>prog </sub></font></td>
        <td><font size="2" face="Arial">HD <sub>prog </sub></font></td>
        <td><font size="2" face="Arial">sec <sub>prog </sub></font></td>
        <td><font size="2" face="Arial">siz <sub>prog </sub></font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial">0</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">0</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">end of track</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">cyl <sub>prog+1 </sub></font></td>
        <td><font size="2" face="Arial">HD <sub>prog </sub></font></td>
        <td><font size="2" face="Arial">1</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">siz <sub>prog </sub></font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial">0</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">1</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">before end of track</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">cyl <sub>prog </sub></font></td>
        <td><font size="2" face="Arial">HD <sub>prog </sub></font></td>
        <td><font size="2" face="Arial">sec <sub>prog </sub></font></td>
        <td><font size="2" face="Arial">siz <sub>prog </sub></font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial">0</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">1</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">end of track</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">cyl <sub>prog+1 </sub></font></td>
        <td><font size="2" face="Arial">HD <sub>prog </sub></font></td>
        <td><font size="2" face="Arial">1</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">siz <sub>prog </sub></font></td>
    </tr>
    <tr>
        <td><font size="2" face="Arial">1</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">0</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">before end of track</font><font
        face="Arial"> </font></td>
        <td><font size="2" face="Arial">cyl <sub>prog </sub>&lt;/f</font></td>
    </tr>
    <font face="Arial"></TBODY></font>
</table>
</body>
</html>
